<!DOCTYPE html>
<html>
  <head>
    <title>LightJockey</title>
    <style>
      body {
        background-color: black;
      }

      button {
        background-color: white;
        border:           none;
        width:            50px;
        height:           50px;
      }
    </style>
    <script>
    
      // https://developers.meethue.com/develop/get-started-2/
      // http://philips-hue/debug/clip.html
      
      const huebridgehost = 'philips-hue';
      const api = 'http://' + huebridgehost + '/api';
      var apiuser = (localStorage.apiuser === undefined) ? '' : localStorage.apiuser;
      var info;
      
      authCheck();

      window.addEventListener('load', (event) => {
        document.querySelectorAll('button').forEach((btn) => {
          btn.addEventListener('mousedown', buttonevent);
          btn.addEventListener('mouseup', buttonevent);
        })
      });

      function buttonevent(e) {
        console.log('%s %s', e.type, e.target.id);
        if (e.target.id == 1) {
          if (e.type == 'mousedown') {
            call('/lights/9/state', 'PUT', '{"on":true}');
          }
          else {
            call('/lights/9/state', 'PUT', '{"on":false}');
          }
        }
      }
   
      function call(endpoint = '', method = 'GET', body = '') {
        let init;
        let callurl = api + '/' + apiuser + endpoint;
        console.log('Calling: ' + callurl + ' ' + method + ' ' + body);
        if (body) init = {method:method,body:body};
        else init = {method:method};
        return fetch(callurl, init).then(response => response.json())
      }

      function authCheck() {
        call().then(response => {
          if (response.config) {
            info = response;
            console.log('Connection to %s (%s) successful', response.config.name, response.config.bridgeid);
          }
          else {
            call('', 'POST', '{"devicetype":"LightJockey"}')
              .then(response => {
                if (response[0]) {
                  if (response[0].error) {
                    if (response[0].error.type == 101) {
                      if (confirm('Not linked with Hue Bridge\nPress the button on the Hue Bridge, then click OK')) authCheck();
                    }
                    else alert(response[0].error.description);
                  }
                  else if (response[0].success && response[0].success.username) {
                    apiuser = localStorage.apiuser = response[0].success.username;
                    authCheck();
                  }
                  else console.log(response);
                }
                else console.log(response);
              });
          }
        });
      }

    </script>
  </head>
  <body>
    <button id=1></button>
    <button id=2></button>
    <button id=3></button>
  </body>
</html>
